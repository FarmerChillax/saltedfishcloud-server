(function(e,p){typeof exports=="object"&&typeof module!="undefined"?p(require("vue")):typeof define=="function"&&define.amd?define(["vue"],p):(e=typeof globalThis!="undefined"?globalThis:e||self,p(e.Vue))})(this,function(e){"use strict";var Je=Object.defineProperty,Ze=Object.defineProperties;var Ge=Object.getOwnPropertyDescriptors;var H=Object.getOwnPropertySymbols;var Xe=Object.prototype.hasOwnProperty,Ye=Object.prototype.propertyIsEnumerable;var z=(e,p,y)=>p in e?Je(e,p,{enumerable:!0,configurable:!0,writable:!0,value:y}):e[p]=y,V=(e,p)=>{for(var y in p||(p={}))Xe.call(p,y)&&z(e,y,p[y]);if(H)for(var y of H(p))Ye.call(p,y)&&z(e,y,p[y]);return e},g=(e,p)=>Ze(e,Ge(p));const p=e.defineComponent({name:"SubtitleSelector"}),y=e.defineComponent(g(V({},p),{props:{subtitles:{type:Array,default:()=>[]}},setup(t){const o=t;return(c,n)=>{const a=e.resolveComponent("v-radio"),i=e.resolveComponent("v-radio-group");return e.openBlock(),e.createBlock(i,null,{default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(o.subtitles,r=>(e.openBlock(),e.createBlock(a,{key:r.index,color:"primary",label:`${r.language}${r.title?"("+r.title+")":""}`,value:r},null,8,["label","value"]))),128))]),_:1})}}})),W=[e.createElementVNode("h1",null,"\u64AD\u653E\u52A0\u8F7D\u5931\u8D25\u4E86QAQ",-1)],K=e.defineComponent({name:"VideoEnhancePlayer"}),Q=e.defineComponent(g(V({},K),{props:{url:{type:String,default:void 0},videoInfo:{type:Object,default:void 0},subtitleUrls:{type:Array,default:()=>[]}},setup(t){const o=t,c=e.ref();let n;const a=()=>{if(!o.url)return;const i={container:c.value,video:{url:o.url}},r=e.ref();if(o.videoInfo){const s=o.videoInfo.streams.filter(l=>l.codecType=="subtitle");s.length&&(window.SfcUtils.snackbar(`\u68C0\u6D4B\u5230${s.length}\u4E2A\u5B57\u5E55`),i.contextmenu=[{text:"\u9009\u62E9\u5B57\u5E55",click(){window.SfcUtils.openComponentDialog(y,{props:e.reactive({subtitles:s,"onUpdate:modelValue"(l){r.value=l},modelValue:r}),title:"\u9009\u62E9\u5B57\u5E55",contentMaxHeight:"360px",async onConfirm(){const l=n.video.currentTime,E=o.subtitleUrls.find(C=>C.index==r.value.index);return E?(i.subtitle={url:E.url,fontSize:"21px"},i.contextmenu[0].text="\u5B57\u5E55\uFF1A"+r.value.language+(r.value.title?"("+r.value.title+")":""),n.destroy(),n=new window.DPlayer(i),n.play(),n.seek(l),!0):(window.SfcUtils.snackbar("\u627E\u4E0D\u5230\u6D41\u7F16\u53F7\u4E3A"+r.value+"\u7684\u5B57\u5E55\u6D41"),!0)}})}}]),o.videoInfo.chapters.length&&(i.highlight=o.videoInfo.chapters.map(l=>({text:l.title,time:Number(l.startTime)})))}n=new window.DPlayer(i),n.play()};return e.onMounted(async()=>{await e.nextTick(),a()}),e.watch(()=>o.url,a),(i,r)=>(e.openBlock(),e.createElementBlock("div",{ref_key:"rootRef",ref:c},W,512))}})),J=e.defineComponent({name:"ConfigureInfo"}),Z=e.defineComponent(g(V({},J),{props:{modelValue:{type:String,default:""}},setup(t){const o=t,c=()=>{window.SfcUtils.alert(o.modelValue,"\u7F16\u8BD1\u53C2\u6570")};return(n,a)=>(e.openBlock(),e.createElementBlock("a",{class:"link",onClick:c},"\u67E5\u770B\u7F16\u8BD1\u53C2\u6570"))}})),G=e.createElementVNode("thead",null,[e.createElementVNode("tr",null,[e.createElementVNode("th",{style:{width:"90px"}}," \u7F16\u7801\u5668 "),e.createElementVNode("th",null,"\u63CF\u8FF0")])],-1),X={class:"break-text"},Y=e.defineComponent({name:"EncoderInfoList"}),M=e.defineComponent(g(V({},Y),{props:{modelValue:{type:Array,default:()=>[]}},setup(t){return(o,c)=>{const n=e.resolveComponent("VTable"),a=e.resolveComponent("EmptyTip");return t.modelValue&&t.modelValue.length?(e.openBlock(),e.createBlock(n,{key:0},{default:e.withCtx(()=>[G,e.createElementVNode("tbody",null,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(t.modelValue,i=>(e.openBlock(),e.createElementBlock("tr",{key:i.name},[e.createElementVNode("td",X,e.toDisplayString(i.name),1),e.createElementVNode("td",null,e.toDisplayString(i.describe),1)]))),128))])]),_:1})):(e.openBlock(),e.createBlock(a,{key:1}))}}})),v=e.defineComponent({name:"EncoderInfo"}),ee=e.defineComponent(g(V({},v),{props:{modelValue:{type:Array,default:()=>[]}},setup(t){const o=t,c=()=>{window.SfcUtils.openComponentDialog(M,{props:{modelValue:o.modelValue},title:"\u7F16\u7801\u5668\u8BE6\u60C5"})};return(n,a)=>(e.openBlock(),e.createElementBlock("a",{class:"link",onClick:c},"\u67E5\u770B\u8BE6\u60C5("+e.toDisplayString(t.modelValue.length)+"\u4E2A)",1))}}));window.bootContext.addProcessor({taskName:"\u6CE8\u518C\u7EC4\u4EF6",execute(t,o){t.component("ConfigureInfo",Z),t.component("EncoderInfo",ee),t.component("EncoderInfoList",M)}});function L(t){return t<10?"0"+t:""+t}var T;(t=>{function o(n){return n<1e3?n+"bps":n<1e6?(Number(n)/1e3).toFixed(2)+"Kbps":n<1e9?(Number(n)/1e6).toFixed(2)+"Mbps":n}t.formatBitRate=o;function c(n){const a=Number(n),i=L(Math.floor(a/3600)),r=L(Math.floor(a/60%60)),s=L(Math.floor(a%60));return`${i}:${r}:${s}`}t.formatDuration=c})(T||(T={}));const te=e.createElementVNode("div",{class:"text-title"}," \u57FA\u672C\u4FE1\u606F ",-1),oe=e.createElementVNode("td",{style:{"min-width":"160px"}}," \u5C01\u88C5\u683C\u5F0F ",-1),ne=e.createElementVNode("td",null,"\u5C01\u88C5\u683C\u5F0F\u5168\u79F0",-1),le=e.createElementVNode("td",null,"\u7801\u7387",-1),ae=e.createElementVNode("td",null,"\u6301\u7EED\u65F6\u957F",-1),re={key:0},ce=e.createElementVNode("td",null,"\u5176\u4ED6\u6807\u8BB0",-1),ie=e.createElementVNode("thead",null,[e.createElementVNode("tr",null,[e.createElementVNode("th",null,"\u540D\u79F0"),e.createElementVNode("th",null,"\u503C")])],-1),de=e.createElementVNode("div",{class:"text-title"}," \u89C6\u9891\u6D41 ",-1),se=e.createElementVNode("thead",null,[e.createElementVNode("tr",null,[e.createElementVNode("th",null,"\u7F16\u7801"),e.createElementVNode("th",null,"\u5206\u8FA8\u7387"),e.createElementVNode("th",null,"\u5E27\u7387"),e.createElementVNode("th",null,"\u8BED\u8A00")])],-1),me=e.createElementVNode("div",{class:"text-title"}," \u97F3\u9891\u6D41 ",-1),ue=e.createElementVNode("thead",null,[e.createElementVNode("tr",null,[e.createElementVNode("th",null,"\u7F16\u7801"),e.createElementVNode("th",null,"\u91C7\u6837"),e.createElementVNode("th",null,"\u7801\u7387"),e.createElementVNode("th",null,"\u58F0\u9053"),e.createElementVNode("th",null,"\u8BED\u8A00")])],-1),pe=e.defineComponent({name:"VideoInfo"}),fe=e.defineComponent(g(V({},pe),{props:{videoInfo:{type:Object,default:()=>({})},file:{type:Object,default:void 0}},setup(t){const o=t,c=e.ref(!1),n=e.computed(()=>o.videoInfo.streams.filter(i=>i.codecType=="video")),a=e.computed(()=>o.videoInfo.streams.filter(i=>i.codecType=="audio"));return(i,r)=>{const s=e.resolveComponent("VTable");return e.openBlock(),e.createElementBlock("div",null,[te,e.createVNode(s,null,{default:e.withCtx(()=>[e.createElementVNode("tbody",null,[e.createElementVNode("tr",null,[oe,e.createElementVNode("td",null,e.toDisplayString(t.videoInfo.format.formatName),1)]),e.createElementVNode("tr",null,[ne,e.createElementVNode("td",null,e.toDisplayString(t.videoInfo.format.formatLongName),1)]),e.createElementVNode("tr",null,[le,e.createElementVNode("td",null,e.toDisplayString(e.unref(T).formatBitRate(t.videoInfo.format.bitRate))+" ("+e.toDisplayString(t.videoInfo.format.bitRate)+")",1)]),e.createElementVNode("tr",null,[ae,e.createElementVNode("td",null,e.toDisplayString(e.unref(T).formatDuration(t.videoInfo.format.duration)),1)]),t.videoInfo.format.tags?(e.openBlock(),e.createElementBlock("tr",re,[ce,e.createElementVNode("td",null,[c.value?(e.openBlock(),e.createBlock(s,{key:0},{default:e.withCtx(()=>[ie,e.createElementVNode("tbody",null,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(Object.keys(t.videoInfo.format.tags),l=>(e.openBlock(),e.createElementBlock("tr",{key:l},[e.createElementVNode("td",null,e.toDisplayString(l),1),e.createElementVNode("td",null,e.toDisplayString(t.videoInfo.format.tags[l]),1)]))),128))])]),_:1})):e.createCommentVNode("",!0),e.createElementVNode("a",{class:"link",onClick:r[0]||(r[0]=l=>c.value=!c.value)},e.toDisplayString(c.value?"\u6536\u8D77":"\u5C55\u5F00"),1)])])):e.createCommentVNode("",!0)])]),_:1}),de,e.createVNode(s,null,{default:e.withCtx(()=>[se,e.createElementVNode("tbody",null,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(n),l=>(e.openBlock(),e.createElementBlock("tr",{key:l.index},[e.createElementVNode("td",null,e.toDisplayString(l.codecName),1),e.createElementVNode("td",null,e.toDisplayString(l.width)+"x"+e.toDisplayString(l.height),1),e.createElementVNode("td",null,e.toDisplayString((l.avgFrameRate||0).toFixed(3)),1),e.createElementVNode("td",null,e.toDisplayString(l.language||"-"),1)]))),128))])]),_:1}),me,e.createVNode(s,null,{default:e.withCtx(()=>[ue,e.createElementVNode("tbody",null,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(a),l=>(e.openBlock(),e.createElementBlock("tr",{key:l.index},[e.createElementVNode("td",null,e.toDisplayString(l.codecName),1),e.createElementVNode("td",null,e.toDisplayString(l.sampleRate/1e3)+"kHz",1),e.createElementVNode("td",null,e.toDisplayString(l.bitRate/1e3)+"K",1),e.createElementVNode("td",null,e.toDisplayString(l.channels),1),e.createElementVNode("td",null,e.toDisplayString(l.language||"-"),1)]))),128))])]),_:1})])}}}));var N;(t=>{function o(){return{url:"/video/getFFMpegInfo"}}t.getFFMpegInfo=o;function c(r){return{url:"/video/encodeConvert",data:r,method:"post",headers:{"Content-Type":"application/json"}}}t.encodeConvert=c;function n(){return{url:"/video/check"}}t.check=n;function a(r,s,l,E){return{url:"/video/listConvertTask",params:{uid:r,status:s,page:l,pageSize:E}}}t.listConvertTask=a;function i(r){return{url:"/video/getLog",params:{taskId:r}}}t.getLog=i})(N||(N={}));const Ee=e.createElementVNode("div",{class:"text-h6"}," \u89C6\u9891 ",-1),ke=e.createElementVNode("thead",null,[e.createElementVNode("tr",null,[e.createElementVNode("th",{style:{width:"64px"}}," \u9009\u62E9 "),e.createElementVNode("th",null,"\u539F\u7F16\u7801"),e.createElementVNode("th",null,"\u8BED\u8A00"),e.createElementVNode("th",null,"\u7F16\u7801\u5668")])],-1),he=e.createElementVNode("div",{class:"text-h6"}," \u97F3\u9891 ",-1),ye=e.createElementVNode("thead",null,[e.createElementVNode("tr",null,[e.createElementVNode("th",{style:{width:"64px"}}," \u9009\u62E9 "),e.createElementVNode("th",null,"\u539F\u7F16\u7801"),e.createElementVNode("th",null,"\u8BED\u8A00"),e.createElementVNode("th",null,"\u7F16\u7801\u5668")])],-1),Ve=e.defineComponent({name:"VideoConvertForm"}),ge=e.defineComponent(g(V({},Ve),{props:{videoInfo:{type:Object,default:()=>({})}},emits:["submit"],setup(t,{expose:o,emit:c}){const n=t,a=e.ref(),i=e.ref(),r={title:"\u590D\u5236",value:"copy"},s=window.FormUtils.defineForm({actions:{async submit(){if(!n.videoInfo.streams.find(m=>(m.codecType=="audio"||m.codecType=="video")&&l.mapStreams[m.index]))throw new Error("\u81F3\u5C11\u9009\u62E9\u4E00\u4E2A\u97F3\u9891\u6216\u89C6\u9891\u6D41");n.videoInfo.streams.find(m=>m.codecType=="video"&&l.mapStreams[m.index])||await window.SfcUtils.confirm("\u6CA1\u6709\u9009\u62E9\u89C6\u9891\u6D41\uFF0C\u786E\u5B9A\uFF1F","\u63D0\u793A",{cancelToReject:!0}),n.videoInfo.streams.find(m=>m.codecType=="audio"&&l.mapStreams[m.index])||await window.SfcUtils.confirm("\u6CA1\u6709\u9009\u62E9\u97F3\u9891\u6D41\uFF0C\u786E\u5B9A\uFF1F","\u63D0\u793A",{cancelToReject:!0}),w()},async loadFFMpegInfo(){_.beginLoading();try{const d=(await window.SfcUtils.request(N.getFFMpegInfo())).data.data;i.value=d,k.video=[r].concat(d.videoEncoders.filter(m=>m.name.includes("264")||m.name.includes("265")||m.name.includes("hevc")).map(m=>({title:m.name,value:m.name}))),k.audio=[r].concat(d.audioEncoders.filter(m=>m.name.includes("aac")).map(m=>({title:m.name,value:m.name}))),k.subtitle=[r].concat(d.subtitleEncoders.map(m=>({title:m.name,value:m.name})))}catch(d){window.SfcUtils.snackbar(d)}finally{_.closeLoading()}}},formData:{convertRules:{},mapStreams:{},enabledConvertRules:[]},formRef:a,validators:{},throwError:!0}),{formData:l,actions:E,validators:C,loadingRef:D,loadingManager:_}=s,w=()=>{l.enabledConvertRules=n.videoInfo.streams.filter(d=>l.mapStreams[d.index]).map(d=>l.convertRules[d.index]),l.enabledConvertRules.forEach(d=>{d.encoder!="copy"?d.method="convert":d.method="copy"})};n.videoInfo.streams.forEach(d=>{l.convertRules[d.index]={index:d.index,encoder:"copy",method:"copy",type:d.codecType},l.mapStreams[d.index]=!0}),w(),e.onMounted(async()=>{await E.loadFFMpegInfo()});const S=e.computed(()=>n.videoInfo.streams.filter(d=>d.codecType=="video")),u=e.computed(()=>n.videoInfo.streams.filter(d=>d.codecType=="audio"));e.computed(()=>n.videoInfo.streams.filter(d=>d.codecType=="subtitle"));const k=e.reactive({video:[],audio:[],subtitle:[]});return o(s),(d,m)=>{const I=e.resolveComponent("LoadingMask"),b=e.resolveComponent("VCheckbox"),U=e.resolveComponent("FormSelect"),h=e.resolveComponent("VTable"),Qe=e.resolveComponent("base-form");return e.openBlock(),e.createBlock(Qe,{ref_key:"formRef",ref:a,"model-value":e.unref(l),"submit-action":e.unref(E).submit},{default:e.withCtx(()=>[e.createVNode(I,{loading:e.unref(D)},null,8,["loading"]),Ee,e.createVNode(h,null,{default:e.withCtx(()=>[ke,e.createElementVNode("tbody",null,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(S),f=>(e.openBlock(),e.createElementBlock("tr",{key:f.index},[e.createElementVNode("td",null,[e.createVNode(b,{modelValue:e.unref(l).mapStreams[f.index],"onUpdate:modelValue":x=>e.unref(l).mapStreams[f.index]=x,color:"primary",style:{"margin-top":"6px"},density:"comfortable","hide-details":""},null,8,["modelValue","onUpdate:modelValue"])]),e.createElementVNode("td",null,e.toDisplayString(f.codecName),1),e.createElementVNode("td",null,e.toDisplayString(f.language||"-"),1),e.createElementVNode("td",null,[e.unref(k).video.length?(e.openBlock(),e.createBlock(U,{key:0,modelValue:e.unref(l).convertRules[f.index].encoder,"onUpdate:modelValue":x=>e.unref(l).convertRules[f.index].encoder=x,disabled:!e.unref(l).mapStreams[f.index],style:{width:"160px"},items:e.unref(k).video,onChange:w},null,8,["modelValue","onUpdate:modelValue","disabled","items"])):e.createCommentVNode("",!0)])]))),128))])]),_:1}),he,e.createVNode(h,null,{default:e.withCtx(()=>[ye,e.createElementVNode("tbody",null,[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(e.unref(u),f=>(e.openBlock(),e.createElementBlock("tr",{key:f.index},[e.createElementVNode("td",null,[e.createVNode(b,{modelValue:e.unref(l).mapStreams[f.index],"onUpdate:modelValue":x=>e.unref(l).mapStreams[f.index]=x,color:"primary",style:{"margin-top":"6px"},density:"comfortable","hide-details":""},null,8,["modelValue","onUpdate:modelValue"])]),e.createElementVNode("td",null,e.toDisplayString(f.codecName),1),e.createElementVNode("td",null,e.toDisplayString(f.language||"-"),1),e.createElementVNode("td",null,[e.unref(k).audio.length?(e.openBlock(),e.createBlock(U,{key:0,modelValue:e.unref(l).convertRules[f.index].encoder,"onUpdate:modelValue":x=>e.unref(l).convertRules[f.index].encoder=x,disabled:!e.unref(l).mapStreams[f.index],style:{width:"160px"},items:e.unref(k).audio,onChange:w},null,8,["modelValue","onUpdate:modelValue","disabled","items"])):e.createCommentVNode("",!0)])]))),128))])]),_:1})]),_:1},8,["model-value","submit-action"])}}})),Ce={style:{padding:"16px"}},_e={class:"d-flex align-center"},we={style:{padding:"0 8px",flex:"1"}},Ne={class:"break-text"},Fe={class:"tip",style:{"line-height":"16px"}},Be={key:0},De={key:1},xe={key:2},be={key:3},Se={key:0,class:"break-text"},Ie={class:"min-width: 64px"},Te=e.createElementVNode("div",null,[e.createElementVNode("a",{style:{"font-size":"9px"}},"\u67E5\u770B\u65E5\u5FD7")],-1),$e=e.createElementVNode("div",null,[e.createElementVNode("a",{style:{"font-size":"9px"}},"\u53D6\u6D88")],-1),Ue=e.defineComponent({name:"EncodeConvertTaskInfo"}),$=e.defineComponent(g(V({},Ue),{props:{task:{type:Object,default(){return{}}},haveLog:{type:Boolean,default:!1},showCancel:{type:Boolean,default:!1}},setup(t){const o=t,c=e.computed(()=>JSON.parse(o.task.params||"{}")),n=window.StringFormatter.toDate,a=async()=>{const r=window.SfcUtils.loadingDialog();try{const s=(await window.SfcUtils.request(N.getLog(o.task.asyncTaskRecord.id))).data.data;s?window.SfcUtils.openComponentDialog(window.components.CodeEditor,{props:{modelValue:s.taskLog,readOnly:!0,useMiniMap:!0,style:{height:"100%"}},fullscreen:!0}):window.SfcUtils.alert("\u6CA1\u80FD\u67E5\u8BE2\u5230\u65E5\u5FD7")}catch(s){window.SfcUtils.alert(s,"\u9519\u8BEF")}finally{r.close()}},i=async()=>{const r=window.SfcUtils.loadingDialog({msg:"\u8BF7\u6C42\u4E2D..."});try{await window.SfcUtils.sleep(150),await window.SfcUtils.request(window.API.asyncTask.interrupt(o.task.asyncTaskRecord.id)),r.close()}catch(s){r.close(),await window.SfcUtils.sleep(250),window.SfcUtils.alert("\u8BF7\u6C42\u5931\u8D25: "+s)}};return(r,s)=>{var D,_;const l=e.resolveComponent("FileIcon"),E=e.resolveComponent("VProgressLinear"),C=e.resolveComponent("CommonIcon");return e.openBlock(),e.createElementBlock("div",Ce,[e.createElementVNode("div",_e,[e.createElementVNode("div",null,[e.createVNode(l,{width:"36","file-name":"aaa.mp4"})]),e.createElementVNode("div",we,[e.createElementVNode("div",Ne,[e.createElementVNode("div",null,e.toDisplayString((_=(D=e.unref(c))==null?void 0:D.source)==null?void 0:_.name),1),e.createElementVNode("div",Fe,[t.task.asyncTaskRecord.executeDate?(e.openBlock(),e.createElementBlock("div",Be," \u6267\u884C\u65E5\u671F: "+e.toDisplayString(e.unref(n)(t.task.asyncTaskRecord.executeDate)),1)):e.createCommentVNode("",!0),t.task.asyncTaskRecord.finishDate?(e.openBlock(),e.createElementBlock("div",De," \u5B8C\u6210\u65E5\u671F: "+e.toDisplayString(e.unref(n)(t.task.asyncTaskRecord.finishDate)),1)):e.createCommentVNode("",!0),t.task.asyncTaskRecord.failedDate?(e.openBlock(),e.createElementBlock("div",xe," \u5931\u8D25\u65E5\u671F: "+e.toDisplayString(e.unref(n)(t.task.asyncTaskRecord.failedDate)),1)):e.createCommentVNode("",!0),t.task.asyncTaskRecord.executeDate?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("div",be,e.toDisplayString(t.task.asyncTaskRecord.status==4?"\u5DF2\u53D6\u6D88":"\u7B49\u5F85\u4E2D"),1))])]),t.task.progress?(e.openBlock(),e.createElementBlock("div",Se,[e.createVNode(E,{color:"primary","model-value":t.task.progress.loaded,max:t.task.progress.total},null,8,["model-value","max"])])):e.createCommentVNode("",!0)]),e.createElementVNode("div",Ie,[e.createElementVNode("div",{class:"text-center link",onClick:a},[e.createElementVNode("div",null,[e.createVNode(C,{color:"primary",icon:"mdi-eye"})]),Te]),t.showCancel?(e.openBlock(),e.createElementBlock("div",{key:0,class:"text-center link",style:{"margin-left":"12px"},onClick:i},[e.createElementVNode("div",null,[e.createVNode(C,{color:"primary",icon:"mdi-close"})]),$e])):e.createCommentVNode("",!0)])])])}}})),Le=e.createTextVNode(" \u8FDB\u884C\u4E2D"),Re=e.createTextVNode(" \u5DF2\u5B8C\u6210"),Ae={key:0},Pe=e.createTextVNode(" \u6267\u884C\u5931\u8D25"),Me={key:0},Oe=e.defineComponent({name:"EncodeConvertTask",components:{EncodeConvertTaskInfo:$}}),je=e.defineComponent(g(V({},Oe),{props:{uid:{type:[String,Number],default:0}},setup(t){const o=t,c=e.ref("1"),n=e.ref(0),a=e.ref([]),i=e.ref([]),r=e.ref(0),s=e.ref([]),l=e.ref(0),E=async u=>(await window.SfcUtils.request(N.listConvertTask(o.uid,u,0,20))).data.data,C=async()=>{const u=E(1),k=E(0),d=await Promise.all([u,k]);n.value=Number(d[0].totalCount)||0,a.value=d[0].content,n.value+=Number(d[1].totalCount),a.value=a.value.concat(d[1].content)},D=async()=>{const u=await E(2);r.value=u.totalCount,i.value=u.content},_=async()=>{const u=await Promise.all([E(3),E(4)]);l.value=Number(u[0].totalCount)+Number(u[1].totalCount),s.value=(u[0].content||[]).concat(u[1].content)};let w,S=!1;return e.onMounted(()=>{D(),C(),_(),w=setInterval(async()=>{if(!S)try{S=!0;let u;c.value=="1"?u=C():c.value=="2"?u=D():u=_(),await u}finally{S=!1}},2500)}),e.onUnmounted(()=>{w&&clearInterval(w)}),(u,k)=>{const d=e.resolveComponent("v-tab"),m=e.resolveComponent("v-tabs"),I=e.resolveComponent("EmptyTip"),b=e.resolveComponent("v-window-item"),U=e.resolveComponent("v-window");return e.openBlock(),e.createElementBlock("div",null,[e.createVNode(m,{modelValue:c.value,"onUpdate:modelValue":k[0]||(k[0]=h=>c.value=h),color:"primary","fixed-tabs":""},{default:e.withCtx(()=>[e.createVNode(d,{value:"1"},{default:e.withCtx(()=>[Le,e.createElementVNode("span",null,"("+e.toDisplayString(n.value)+")",1)]),_:1}),e.createVNode(d,{value:"2"},{default:e.withCtx(()=>[Re,r.value?(e.openBlock(),e.createElementBlock("span",Ae,"("+e.toDisplayString(r.value)+")",1)):e.createCommentVNode("",!0)]),_:1}),e.createVNode(d,{value:"3"},{default:e.withCtx(()=>[Pe,l.value?(e.openBlock(),e.createElementBlock("span",Me,"("+e.toDisplayString(l.value)+")",1)):e.createCommentVNode("",!0)]),_:1})]),_:1},8,["modelValue"]),e.createVNode(U,{modelValue:c.value,"onUpdate:modelValue":k[1]||(k[1]=h=>c.value=h)},{default:e.withCtx(()=>[e.createVNode(b,{value:"1"},{default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(a.value,h=>(e.openBlock(),e.createBlock($,{key:h.id,task:h,"show-cancel":""},null,8,["task"]))),128)),a.value.length?e.createCommentVNode("",!0):(e.openBlock(),e.createBlock(I,{key:0}))]),_:1}),e.createVNode(b,{value:"2"},{default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(i.value,h=>(e.openBlock(),e.createBlock($,{key:h.id,task:h,"have-log":!0},null,8,["task"]))),128)),i.value.length?e.createCommentVNode("",!0):(e.openBlock(),e.createBlock(I,{key:0}))]),_:1}),e.createVNode(b,{value:"3"},{default:e.withCtx(()=>[(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(s.value,h=>(e.openBlock(),e.createBlock($,{key:h.id,task:h,"have-log":!0},null,8,["task"]))),128)),s.value.length?e.createCommentVNode("",!0):(e.openBlock(),e.createBlock(I,{key:0}))]),_:1})]),_:1},8,["modelValue"])])}}})),qe=e.createTextVNode(" \u68C0\u67E5 "),He=e.defineComponent({name:"VideoEnhanceCheck"}),O=e.defineComponent(g(V({},He),{setup(t){const o=window.SfcUtils,c=async()=>{const n=window.SfcUtils.loadingDialog({msg:"\u68C0\u67E5\u4E2D..."});try{await o.request(N.check()),n.close(),await o.sleep(250),await o.alert("\u914D\u7F6E\u6B63\u786E")}catch(a){n.close(),await o.sleep(250),o.alert(""+a,"\u914D\u7F6E\u9519\u8BEF")}};return(n,a)=>{const i=e.resolveComponent("VBtn");return e.openBlock(),e.createElementBlock("div",null,[e.createVNode(i,{onClick:c},{default:e.withCtx(()=>[qe]),_:1})])}}})),F=window.context,B=window.SfcUtils;function ze(t,o,c,n){if(!o.name.endsWith(".mkv"))return null;const a={name:o.name,path:c,protocol:"subtitle",targetId:t.uid,stream:n};if(t.protocol=="main")return window.SfcUtils.getApiUrl(window.API.resource.getCommonResource(a));const i=t.getProtocolParams();return a.sourceProtocol=t.protocol,a.sourceId=i.id,Object.keys(i).filter(r=>r!="id").forEach(r=>{a[r]=i[r]}),window.SfcUtils.getApiUrl(window.API.resource.getCommonResource(a))}async function R(t,o,c){const n={name:o.name,path:c,targetId:t.uid,sourceProtocol:t.protocol||"main",protocol:t.protocol||"main"},a=t.getProtocolParams();return n.sourceId=a.id,Object.keys(a).filter(i=>i!="id").forEach(i=>{n[i]=a[i]}),n}async function A(t,o,c){const n=await R(t,o,c);return n.protocol="videoInfo",(await await B.request(window.API.resource.getCommonResource(n))).data}const We=new Set(["mp4","mkv","avi","rm","rmvb","m4v","flv","mpg","mpeg","mpe","ts"]);function P(t){const o=t.split(".").pop();return!!o&&We.has(o)}const j={id:"player",icon:"mdi-play-circle",matcher(t,o){return P(o.name)},title:"\u64AD\u653E\u89C6\u9891",async action(t,o){try{let c=o.path;c||(c=(await B.request(window.API.resource.parseNodeId(o.uid,o.node))).data.data),B.beginLoading(),await window.SfcUtils.sleep(100);const n=await A(t,o,c);B.openComponentDialog(Q,{props:{url:t.getFileUrl(o),videoInfo:n,subtitleUrls:n.streams.filter(a=>a.codecType=="subtitle").map(a=>({index:a.index,url:ze(t,o,c,a.index)}))},dense:!0,showCancel:!1,title:"\u89C6\u9891\u9884\u89C8\uFF1A"+o.name,extraDialogOptions:{maxWidth:"80%"}})}catch(c){B.snackbar(c)}finally{B.closeLoading()}},sort:0},Ke={id:"video",name:"\u89C6\u9891",items:[{title:"\u89C6\u9891\u8F6C\u7801",id:"video-convert",icon:"mdi-cached",renderOn(t){return t&&t.selectFileList.length==1&&!t.selectFileList[0].mount&&P(t.selectFileList[0].name)&&!t.readonly},async action(t){const o=t.selectFileList[0],c=await A(t,o,o.path),n=window.SfcUtils.openComponentDialog(ge,{props:{videoInfo:c},title:`\u89C6\u9891\u8F6C\u7801\uFF1A${t.selectFileList[0].name}`,async onConfirm(){const a=window.SfcUtils.loadingDialog({msg:"\u4EFB\u52A1\u521B\u5EFA\u4E2D"});try{if((await n.getInstAsForm().submit()).success){const r=n.getInstAsForm().getFormData().enabledConvertRules,s=await R(t,o,o.path),l=await R(t,o,o.path);return l.name="convert_"+l.name,await window.SfcUtils.request(N.encodeConvert({rules:r,source:s,target:l})),window.SfcUtils.snackbar("\u4EFB\u52A1\u521B\u5EFA\u6210\u529F"),!0}else return!1}catch(i){return B.snackbar(i),!1}finally{a.close()}}})}},{title:"\u89C6\u9891\u4FE1\u606F",id:"video-info",renderOn(t){return t&&t.selectFileList.length==1&&!t.selectFileList[0].mount&&P(t.selectFileList[0].name)},icon:"mdi-information-variant",async action(t){const o=await A(t,t.selectFileList[0],t.selectFileList[0].path);window.SfcUtils.openComponentDialog(fe,{props:{videoInfo:o},title:`\u5A92\u4F53\u4FE1\u606F\uFF1A${t.selectFileList[0].name}`})}}]};F.menu.value.boxMenu.push({name:"\u89C6\u9891\u670D\u52A1",id:"video",items:[{id:"encoder-convert",title:"\u89C6\u9891\u8F6C\u7801",icon:"mdi-cached",renderOn(){return!!F.session.value.token},action(t){t.title="\u89C6\u9891\u8F6C\u7801",t.currentComponent=e.h(je,{style:{maxWidth:"640px",margin:"auto"},uid:F.session.value.user.id})}}]});const q=F.fileOpenHandler.value.findIndex(t=>t.id=="play-video");q!=-1?F.fileOpenHandler.value[q]=j:F.fileOpenHandler.value.push(j),F.menu.value.fileListMenu.push(Ke),window.bootContext.addProcessor({taskName:"\u6CE8\u518C\u7EC4\u4EF6-video-enhance",execute(t){t.component(O.name,O)}})});
